---
title: etcd入门篇之客户端设计
layout: post
header-img: "https://w.wallhaven.cc/full/ex/wallhaven-ex9gwo.png"
description: etcd系列第二篇博客
author: 陈家辉
tags:
- etcd
---

# 介绍

etcd绝大部分复杂的应用逻辑由服务端完成，并且服务端可以保证服务的健壮性。虽然服务器组件是正确的，但它与客户端的组合需要一套不同的复杂协议来保证其正确性和故障情况下的高可用性。理想情况下，etcd 服务器提供许多物理机器的一个逻辑集群视图，客户机实现副本之间的自动故障转移。

## 专有词汇

*clientv3*：基于etcd v3 API 的官方Go语言客户端。

*均衡器*：etcd客户端负载均衡器实现重试和故障转移机制。 etcd 客户端自动平衡多个端点之间的负载。

*端点*“： 客户端可以连接到的 etcd 服务器端点列表。通常，一个 etcd 集群的3个或5个客户端 URL。

*固定端点*： 当配置有多个端点时，< = v3.3客户端平衡器只选择一个端点来建立 TCP 连接，以保存到 etcd 集群的总开放连接。在 v3.4中，平衡器轮循为每个请求固定端点，从而更均匀地分配负载。

*客户端连接*：通过 gRPC Dial 建立到 etcd 服务器的 TCP 连接。

*子连接*: gRPC SubConn 接口。每个子连接包含一个地址列表。Balancer 根据已解析地址列表创建 SubConn。GRPC ClientConn 可以映射到多个 SubConn (例如 example.com 解析为两个子连接中的10.10.10.1和10.10.10.2)。Etcd v3.4平衡器使用内部解析器为每个端点建立一个子连接。

*临时断联*： 当 gRPC 服务器返回代码状态错误时，不可用。

# 需求

**正确性**

如果存在服务器故障，请求可能会失败。然而，一定不会违背一致性保证：全局顺序性，不写错误数据，可变操作最多一次语义，局部事件不会被观测等等。

**存活**

服务端可能故障或短暂失联。客户端不应该死锁等待服务器从脱机状态恢复，除非配置为这样做。理想情况下，客户端通过 HTTP/2 ping 检测不可用的服务器，并通过明确的错误消息将故障转移到其他节点。

**有效性**

客户端应该以最少的资源有效地操作: 以前的 TCP 连接应该在端点切换之后优雅地关闭。故障转移机制应该能够有效地预测下一个要连接的副本，而不会在失败的节点上浪费时间重试。

**便携性**

正式客户端应该有明确的文档，其实现应该适用于其他语言绑定。不同语言绑定之间的错误处理应该是一致的。由于 etcd 完全致力于 gRPC，因此实现应该与 gRPC 长期设计目标密切一致(例如，可插入重试策略应该与 gRPC 重试兼容)。客户端版本的升级应该是无干扰的。

# 概述

客户端的由以下组件组成：

* 均衡器，用于与服务端集群建立gRPC链接
* API客户端负责发送RPCs给服务端，以及错误处理，它决定是否重试失败请求或者切换端点。

``mermaid
graph LR
A-->B
```



